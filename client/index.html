<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASU Engineering RAG Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="icon">ðŸ¤–</div>
                <h1>ASU <span>RAG</span></h1>
                <button id="close-sidebar" class="mobile-only-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="nav-links">
                <div class="nav-item active">
                    <i class="fas fa-comment-dots"></i>
                    <span>Chat Assistant</span>
                </div>
                <!-- Future features could go here -->
                <div class="nav-item" id="sidebar-db-btn">
                    <i class="fas fa-database"></i>
                    <span>Database</span>
                </div>
                <div class="nav-item" id="sidebar-settings-btn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="disclaimer">
                    Powered by ASU Engineering
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <header>
                <div class="status-indicator">
                    <button id="menu-toggle" class="mobile-only-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="status-dot"></span>
                    <span class="status-text">Connected</span>
                </div>
                <div class="header-actions">
                    <button id="db-btn" class="icon-btn" title="Database Management">
                        <i class="fas fa-server"></i>
                    </button>
                    <button id="settings-btn" class="icon-btn" title="Settings">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                </div>
            </header>

            <div class="chat-container" id="chat-container">
                <div class="welcome-message">
                    <h2>Hello, <span>How can I help you?</span></h2>
                    <p>Access your documents through natural language. Ask specific questions or explore topics.</p>
                    <div class="suggested-queries">
                        <button onclick="setQuery('What are the available departments?')">Departments</button>
                        <button onclick="setQuery('Tell me about the bylaws.')">Bylaws</button>
                        <button onclick="setQuery('How to apply for graduation?')">Graduation</button>
                    </div>
                </div>
            </div>

            <div class="input-area-wrapper">
                <div class="input-area">
                    <div class="mode-dropdown-container">
                        <select id="chat-mode" class="mode-select-compact">
                            <option value="normal">ðŸ”˜ Normal</option>
                            <option value="deep">ðŸ§  Deep Thinking</option>
                        </select>
                    </div>
                    <textarea id="user-input" placeholder="Message RAG Assistant..." rows="1"></textarea>
                    <button id="send-btn">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>Settings</h2>

                <div class="modal-body">
                    <div class="setting-group">
                        <label for="provider-select">LLM Provider</label>
                        <select id="provider-select">
                            <option value="openai">OpenAI</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="vllm">vLLM (Local)</option>
                        </select>
                        <p class="setting-hint">Choose where your AI model is hosted.</p>
                    </div>

                    <div class="setting-group">
                        <label for="embedding-provider-select">Embedding Provider</label>
                        <select id="embedding-provider-select">
                            <option value="openai">OpenAI</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="vllm">vLLM (Local)</option>
                        </select>
                        <p class="setting-hint">Provider for document vectorization (FAISS).</p>
                    </div>

                    <div id="local-settings" class="provider-settings-group" style="display: none;">
                        <div class="setting-group" id="vllm-url-group" style="display: none;">
                            <label for="vllm-url">Provider Base URL (vLLM)</label>
                            <input type="text" id="vllm-url" placeholder="http://localhost:9090/v1">
                        </div>

                        <div class="setting-group" id="llm-model-group">
                            <label for="model-select">LLM Model</label>
                            <select id="model-select">
                                <option value="" disabled selected>Select a model...</option>
                            </select>
                            <p class="setting-hint" id="model-hint">Select the model for chat generation.</p>
                        </div>

                        <div class="setting-group" id="embedding-model-group">
                            <label for="embedding-model-select">Embedding Model</label>
                            <select id="embedding-model-select">
                                <option value="" disabled selected>Select a model...</option>
                            </select>
                            <p class="setting-hint">Select the model for vector embeddings.</p>
                        </div>
                    </div>

                    <div id="cloud-settings" class="provider-settings-group" style="display: none;">
                        <div class="setting-group" id="openai-key-group">
                            <label for="openai-api-key">OpenAI API Key</label>
                            <input type="password" id="openai-api-key" placeholder="sk-...">
                        </div>
                        <div class="setting-group" id="openai-url-group">
                            <label for="openai-base-url">OpenAI Base URL</label>
                            <input type="text" id="openai-base-url" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="setting-group" id="gemini-key-group">
                            <label for="gemini-api-key">Gemini API Key</label>
                            <input type="password" id="gemini-api-key" placeholder="AIza...">
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="save-settings-btn" class="primary-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Modal -->
    <div id="db-modal" class="modal">
        <div class="modal-content wide-modal">
            <span class="close-db-btn">&times;</span>
            <h2><i class="fas fa-server"></i> Database Management</h2>

            <!-- Section 1: Upload -->
            <div class="db-section">
                <h3>1. Upload Resource</h3>
                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="file-input" accept=".pdf" hidden>
                    <p><i class="fas fa-cloud-upload-alt"></i> Drag & Drop PDF here or <a href="#"
                            id="browse-btn">Browse</a></p>
                    <span id="file-name-display"></span>
                </div>
                <button id="upload-btn" class="action-btn" disabled>Upload File</button>
            </div>

            <!-- Section 2: Web Resource -->
            <div class="db-section">
                <h3>2. Web Resource</h3>
                <div class="url-input-group">
                    <input type="text" id="web-url-input" placeholder="https://example.com/about">
                    <button id="web-ingest-btn" class="action-btn">
                        <i class="fas fa-spider"></i> Crawl & Ingest
                    </button>
                </div>
            </div>

            <!-- Section 3: SQL Database Resource -->
            <div class="db-section">
                <h3>3. SQL Database Resource</h3>
                <div class="db-resource-group">
                    <div class="field-row">
                        <label>Schema:</label>
                        <select id="db-schema-select">
                            <option value="">Default / Loading...</option>
                        </select>
                    </div>
                    <div class="field-row">
                        <label>Tables:</label>
                        <div id="db-tables-container" class="tables-checklist">
                            <p class="hint">Select schema to load tables...</p>
                        </div>
                    </div>
                    <button id="db-ingest-btn" class="action-btn">
                        <i class="fas fa-database"></i> Ingest Selected Tables
                    </button>
                </div>
            </div>

            <!-- Section 4: Resource Management -->
            <div class="db-section">
                <h3>4. Managed Resources</h3>
                <div id="resource-list-container" class="resource-management-list">
                    <p class="hint">Loading managed resources...</p>
                </div>
            </div>

            <!-- Section 5: System Operations -->
            <div class="db-section">
                <h3>5. System Operations</h3>
                <div class="button-group">
                    <button id="stream-btn" class="action-btn warning-btn">
                        <i class="fas fa-sync"></i> Quick Sync (Update)
                    </button>
                    <button id="fresh-stream-btn" class="action-btn danger-btn">
                        <i class="fas fa-hammer"></i> Fresh Build (Reset Index)
                    </button>
                </div>
                <div class="danger-zone"
                    style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color);">
                    <button id="reset-all-btn" class="action-btn delete-btn-full">
                        <i class="fas fa-trash-alt"></i> Wipe All Data & Reset
                    </button>
                </div>
            </div>

            <!-- Section 3: Live Logs -->
            <div class="db-section">
                <h3>3. Live System Logs</h3>
                <div id="console-output" class="terminal-window">
                    <span class="log-line system">> System ready. Waiting for command...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Settings saved successfully</span>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        // Dynamically get the API base URL from the current window location
        const API_BASE = window.location.origin;

        function setQuery(query) {
            userInput.value = query;
            sendMessage();
        }

        function addMessage(content, isUser = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerText = isUser ? 'ðŸ‘¤' : 'AI';

            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.innerText = content;

            msgDiv.appendChild(avatar);
            msgDiv.appendChild(textDiv);
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return textDiv;
        }

        async function sendMessage() {
            const question = userInput.value.trim();
            const chatMode = document.getElementById('chat-mode').value;
            const isDeepThinking = chatMode === 'deep';

            if (!question) return;

            userInput.value = '';
            addMessage(question, true);

            const botTextDiv = addMessage('', false);
            botTextDiv.innerHTML = '<div class="typing">AI Assistant is thinking...</div>';

            try {
                const response = await fetch(`${API_BASE}/ask/stream?question=${encodeURIComponent(question)}&deep_thinking=${isDeepThinking}`);

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedAnswer = '';

                botTextDiv.innerHTML = ''; // Clear thinking state

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            if (data.type === 'sources') {
                                // Optional: display sources separately
                                console.log('Sources:', data.sources);
                            } else if (data.type === 'chunk') {
                                accumulatedAnswer += data.content;
                                botTextDiv.innerHTML = marked.parse(accumulatedAnswer);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } else if (data.type === 'metadata') {
                                // Add performance metrics and sources
                                const metaDiv = document.createElement('div');
                                metaDiv.className = 'message-meta';

                                const stats = [
                                    { label: 'Model', value: data.model, icon: 'fa-robot' },
                                    { label: 'Total', value: data.performance.total, icon: 'fa-clock' },
                                    { label: 'LLM', value: data.performance.llm, icon: 'fa-microchip' },
                                    { label: 'Tokens', value: data.tokens, icon: 'fa-brain' }
                                ];

                                stats.forEach(stat => {
                                    const item = document.createElement('div');
                                    item.className = 'meta-item';
                                    item.innerHTML = `<i class="fas ${stat.icon}"></i> ${stat.label}: ${stat.value}`;
                                    metaDiv.appendChild(item);
                                });

                                if (data.sources && data.sources.length > 0) {
                                    const sourceContainer = document.createElement('div');
                                    sourceContainer.className = 'source-badges';
                                    data.sources.forEach(src => {
                                        const badge = document.createElement('span');
                                        badge.className = 'source-badge';
                                        badge.innerText = src.startsWith('http') ? new URL(src).hostname : src.split('/').pop();
                                        badge.title = src;
                                        sourceContainer.appendChild(badge);
                                    });
                                    metaDiv.appendChild(sourceContainer);
                                }

                                botTextDiv.appendChild(metaDiv);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } else if (data.type === 'error') {
                                botTextDiv.innerText = `Error: ${data.content}`;
                            }
                        } catch (e) {
                            console.error('Error parsing JSON chunk', e);
                        }
                    }
                }
            } catch (error) {
                botTextDiv.innerText = `Error: ${error.message}`;
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Settings Modal Logic
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeModal = document.querySelector('.close-btn');
        const modelSelect = document.getElementById('model-select');
        const saveSettings = document.getElementById('save-settings-btn');

        const providerSelect = document.getElementById('provider-select');
        const embeddingProviderSelect = document.getElementById('embedding-provider-select');
        const localSettings = document.getElementById('local-settings');
        const embeddingModelSelect = document.getElementById('embedding-model-select');
        const cloudSettings = document.getElementById('cloud-settings');
        const openaiApiKeyInput = document.getElementById('openai-api-key');
        const openaiBaseUrlInput = document.getElementById('openai-base-url');
        const geminiApiKeyInput = document.getElementById('gemini-api-key');
        const vllmUrlInput = document.getElementById('vllm-url');
        const vllmUrlGroup = document.getElementById('vllm-url-group');
        const modelHint = document.getElementById('model-hint');

        let currentConfig = null;

        providerSelect.onchange = async () => {
            const provider = providerSelect.value;
            localSettings.style.display = (provider === 'ollama' || provider === 'vllm') ? 'block' : 'none';
            cloudSettings.style.display = (provider === 'openai' || provider === 'gemini') ? 'block' : 'none';
            vllmUrlGroup.style.display = provider === 'vllm' ? 'block' : 'none';

            // Show/hide specific cloud groups
            document.getElementById('openai-key-group').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('openai-url-group').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('gemini-key-group').style.display = provider === 'gemini' ? 'block' : 'none';

            if (provider === 'ollama' || provider === 'vllm' || provider === 'openai' || provider === 'gemini') {
                modelHint.innerText = `Select the ${provider} model for chat generation.`;
                await loadModels(provider, null, modelSelect);
            }
        };

        embeddingProviderSelect.onchange = async () => {
            const provider = embeddingProviderSelect.value;
            if (provider === 'ollama' || provider === 'vllm') {
                const baseUrl = provider === 'vllm' ? vllmUrlInput.value : null;
                await loadModels(provider, baseUrl, embeddingModelSelect);

                if (currentConfig && provider === currentConfig.embedding_provider) {
                    embeddingModelSelect.value = (provider === 'ollama') ? currentConfig.ollama.embedding_model : currentConfig.vllm.embedding_model;
                }
            }
        };

        // Debounced model loading for URL change
        let vllmUrlTimeout;
        vllmUrlInput.oninput = () => {
            clearTimeout(vllmUrlTimeout);
            vllmUrlTimeout = setTimeout(() => {
                if (providerSelect.value === 'vllm') loadModels('vllm', vllmUrlInput.value, modelSelect);
                if (embeddingProviderSelect.value === 'vllm') loadModels('vllm', vllmUrlInput.value, embeddingModelSelect);
            }, 800);
        };

        const openSettingsModal = async () => {
            if (dbModal) dbModal.style.display = 'none';
            settingsModal.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/config/current`);
                currentConfig = await response.json();

                providerSelect.value = currentConfig.provider;
                embeddingProviderSelect.value = currentConfig.embedding_provider || currentConfig.provider;

                if (currentConfig.vllm) vllmUrlInput.value = currentConfig.vllm.base_url || '';
                if (currentConfig.openai) {
                    openaiApiKeyInput.value = currentConfig.openai.api_key || '';
                    openaiBaseUrlInput.value = currentConfig.openai.base_url || 'https://api.openai.com/v1';
                }
                if (currentConfig.gemini) geminiApiKeyInput.value = currentConfig.gemini.api_key || '';

                await providerSelect.onchange();
                await embeddingProviderSelect.onchange();
            } catch (error) {
                console.error('Failed to load current config:', error);
            }
        };

        closeModal.onclick = () => {
            settingsModal.style.display = 'none';
        }

        async function loadModels(provider, baseUrl = null, targetSelect) {
            if (!provider) provider = providerSelect.value;

            let url = `${API_BASE}/models/${provider}`;
            const params = new URLSearchParams();

            if (provider === 'vllm' && (baseUrl || vllmUrlInput.value)) params.append('base_url', baseUrl || vllmUrlInput.value);
            if (provider === 'openai') {
                if (openaiApiKeyInput.value) params.append('api_key', openaiApiKeyInput.value);
                if (openaiBaseUrlInput.value) params.append('base_url', openaiBaseUrlInput.value);
            }
            if (provider === 'gemini' && geminiApiKeyInput.value) params.append('api_key', geminiApiKeyInput.value);

            const queryString = params.toString();
            if (queryString) url += `?${queryString}`;

            targetSelect.innerHTML = '<option value="" disabled selected>Loading models...</option>';

            try {
                const response = await fetch(url);
                const data = await response.json();

                targetSelect.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.text = model;
                        targetSelect.appendChild(option);
                    });
                } else {
                    targetSelect.innerHTML = '<option value="">No models found</option>';
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                targetSelect.innerHTML = '<option value="">Error connecting</option>';
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            toastMsg.innerText = message;
            toast.classList.add('show');
            if (isError) {
                toast.style.borderLeft = '4px solid #f43f5e';
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
                toast.querySelector('i').style.color = '#f43f5e';
            } else {
                toast.style.borderLeft = '4px solid #10b981';
                toast.querySelector('i').className = 'fas fa-check-circle';
                toast.querySelector('i').style.color = '#10b981';
            }
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        saveSettings.onclick = async () => {
            const provider = providerSelect.value;
            const embedProvider = embeddingProviderSelect.value;
            const updates = {
                "LLM_PROVIDER": provider,
                "EMBEDDING_PROVIDER": embedProvider
            };

            if (provider === 'ollama' || provider === 'vllm') {
                updates[provider === 'ollama' ? "OLLAMA_LLM_MODEL" : "VLLM_MODEL"] = modelSelect.value;
            }

            if (embedProvider === 'ollama' || embedProvider === 'vllm') {
                updates[embedProvider === 'ollama' ? "OLLAMA_EMBEDDING_MODEL" : "VLLM_EMBEDDING_MODEL"] = embeddingModelSelect.value;
            }

            if (provider === 'vllm' || embedProvider === 'vllm') {
                updates["VLLM_BASE_URL"] = vllmUrlInput.value;
            }

            if (provider === 'openai') {
                updates["OPENAI_API_KEY"] = openaiApiKeyInput.value;
                updates["OPENAI_BASE_URL"] = openaiBaseUrlInput.value;
                updates["OPENAI_LLM_MODEL"] = modelSelect.value;
            }

            if (provider === 'gemini') {
                updates["GEMINI_API_KEY"] = geminiApiKeyInput.value;
                updates["GEMINI_MODEL"] = modelSelect.value;
            }

            saveSettings.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveSettings.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/config/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    settingsModal.style.display = 'none';
                    showToast(`Settings updated successfully`);
                } else {
                    throw new Error('Failed to update');
                }
            } catch (error) {
                showToast('Failed to update settings', true);
            } finally {
                saveSettings.innerText = 'Save Changes';
                saveSettings.disabled = false;
            }
        }
        // ==========================================
        // DATABASE & INGESTION LOGIC
        // ==========================================
        const dbModal = document.getElementById('db-modal');
        const dbBtn = document.getElementById('db-btn');
        const closeDbBtn = document.querySelector('.close-db-btn'); // Note: changed class in HTML
        const fileInput = document.getElementById('file-input');
        const uploadZone = document.getElementById('upload-zone');
        const uploadBtn = document.getElementById('upload-btn');
        const fileNameDisplay = document.getElementById('file-name-display');
        const browseBtn = document.getElementById('browse-btn');
        const consoleOutput = document.getElementById('console-output');
        const streamBtn = document.getElementById('stream-btn');
        const freshStreamBtn = document.getElementById('fresh-stream-btn');

        // Open/Close Modal
        const openDbModal = () => {
            // Ensure mutual exclusion
            if (settingsModal) settingsModal.style.display = 'none';

            dbModal.style.display = 'block';
            loadSchemas();
            loadTables(""); // Load default schema tables
            loadResources(); // Load handled resources
        };

        dbBtn.onclick = openDbModal;
        settingsBtn.onclick = openSettingsModal;
        document.getElementById('sidebar-db-btn').onclick = openDbModal;
        document.getElementById('sidebar-settings-btn').onclick = openSettingsModal;

        closeDbBtn.addEventListener('click', () => {
            dbModal.style.display = 'none';
        });

        // Close on outside click is handled by window.onclick below

        // File Selection Logic
        browseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            fileInput.click();
        });

        uploadZone.addEventListener('click', (e) => {
            if (e.target !== browseBtn) fileInput.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--accent-color)';
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--border-color)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--border-color)';
            if (e.dataTransfer.files.length) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (fileInput.files.length) {
                handleFileSelect(fileInput.files[0]);
            }
        });

        let selectedFile = null;

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a valid PDF file.');
                return;
            }
            selectedFile = file;
            fileNameDisplay.textContent = `Selected: ${file.name}`;
            uploadBtn.disabled = false;
        }

        // Upload Logic
        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('File uploaded successfully!');
                    fileNameDisplay.textContent = '';
                    selectedFile = null;
                    logToConsole(`UPLOAD SUCCESS: ${data.message}`, 'success');
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                alert('Error uploading file');
                logToConsole(`UPLOAD ERROR: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Upload File';
            }
        });

        // Console Logging Helper
        function logToConsole(message, type = 'info') {
            const line = document.createElement('span');
            line.className = `log-line ${type}`;
            line.textContent = `> ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Streaming Logic
        async function startIngestionStream(fresh = false) {
            const url = `${API_BASE}/ingest/pdf/stream${fresh ? '?fresh=true' : ''}`;

            streamBtn.disabled = true;
            freshStreamBtn.disabled = true;
            logToConsole(fresh ? 'Starting FRESH build...' : 'Starting SYNC...', 'system');

            try {
                const response = await fetch(url);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.trim()) {
                            // Check for error keywords
                            let type = 'info';
                            if (line.includes('ERROR') || line.includes('failed')) type = 'error';
                            if (line.includes('SUCCESS') || line.includes('saved')) type = 'success';
                            if (line.includes('WARNING')) type = 'warning';

                            logToConsole(line, type);
                        }
                    });
                }
                logToConsole('Process finished.', 'system');

            } catch (error) {
                logToConsole(`STREAM ERROR: ${error.message}`, 'error');
            } finally {
                streamBtn.disabled = false;
                freshStreamBtn.disabled = false;
            }
        }

        streamBtn.addEventListener('click', () => startIngestionStream(false));
        freshStreamBtn.addEventListener('click', () => startIngestionStream(true));

        // Resource Management Logic
        async function loadResources() {
            const container = document.getElementById('resource-list-container');
            try {
                const response = await fetch(`${API_BASE}/resources`);
                const data = await response.json();

                container.innerHTML = '';

                const sections = [
                    { title: 'ðŸ“‘ PDFs', key: 'pdfs', type: 'pdfs' },
                    { title: 'ðŸŒ Websites', key: 'websites', type: 'websites' },
                    { title: 'ðŸ“ DB Tables', key: 'databases', type: 'databases' }
                ];

                let totalItems = 0;
                sections.forEach(sec => {
                    if (data[sec.key] && data[sec.key].length > 0) {
                        const secDiv = document.createElement('div');
                        secDiv.className = 'res-section';
                        secDiv.innerHTML = `<h4>${sec.title}</h4>`;

                        data[sec.key].forEach(item => {
                            totalItems++;
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'res-item';
                            itemDiv.innerHTML = `
                                <span>${item}</span>
                                <button onclick="deleteResource('${sec.type}', '${item}')" class="delete-res-btn" title="Remove Archive">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            secDiv.appendChild(itemDiv);
                        });
                        container.appendChild(secDiv);
                    }
                });

                if (totalItems === 0) {
                    container.innerHTML = '<p class="hint">No resources ingested yet.</p>';
                }
            } catch (error) {
                container.innerHTML = '<p class="hint error">Failed to load resources.</p>';
            }
        }

        async function deleteResource(type, name) {
            if (!confirm(`Are you sure you want to remove "${name}"? This will delete the source file and associations.`)) return;

            try {
                const response = await fetch(`${API_BASE}/resources/${type}/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message);
                    loadResources();
                } else {
                    throw new Error(result.detail || 'Delete failed');
                }
            } catch (error) {
                showToast(error.message, true);
            }
        }

        document.getElementById('reset-all-btn').onclick = async () => {
            if (!confirm("CRITICAL ACTION: This will delete ALL uploaded PDFs, clear the entire search index, and reset configurations. Proceed?")) return;

            try {
                const response = await fetch(`${API_BASE}/resources/reset`, { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    showToast("System reset successfully");
                    loadResources();
                    logToConsole("SYSTEM RESET: All data wiped.", "warning");
                } else {
                    throw new Error('Reset failed');
                }
            } catch (error) {
                showToast(error.message, true);
            }
        };

        // Web Ingestion Logic
        const webUrlInput = document.getElementById('web-url-input');
        const webIngestBtn = document.getElementById('web-ingest-btn');

        async function startWebIngestionStream() {
            const url = webUrlInput.value.trim();
            if (!url) {
                alert('Please enter a URL first.');
                return;
            }

            const streamUrl = `${API_BASE}/ingest/web/stream?url=${encodeURIComponent(url)}`;
            webIngestBtn.disabled = true;
            logToConsole(`Starting WEB CRAWL for ${url}...`, 'system');

            try {
                const response = await fetch(streamUrl);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.trim()) {
                            let type = 'info';
                            if (line.includes('ERROR') || line.includes('failed')) type = 'error';
                            if (line.includes('SUCCESS') || line.includes('saved')) type = 'success';
                            if (line.includes('WARNING')) type = 'warning';
                            logToConsole(line, type);
                        }
                    });
                }
                logToConsole('Web ingestion finished.', 'system');
            } catch (error) {
                logToConsole(`WEB STREAM ERROR: ${error.message}`, 'error');
            } finally {
                webIngestBtn.disabled = false;
            }
        }

        webIngestBtn.addEventListener('click', startWebIngestionStream);

        // SQL Database Ingestion Logic
        const schemaSelect = document.getElementById('db-schema-select');
        const tablesContainer = document.getElementById('db-tables-container');
        const dbIngestBtn = document.getElementById('db-ingest-btn');

        async function loadSchemas() {
            try {
                const response = await fetch(`${API_BASE}/db/schemas`);
                const data = await response.json();
                if (data.schemas) {
                    schemaSelect.innerHTML = '<option value="">Select Schema...</option>';
                    data.schemas.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        schemaSelect.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Failed to load schemas:', error);
            }
        }

        async function loadTables(schema) {
            tablesContainer.innerHTML = '<p class="hint">Loading tables...</p>';
            try {
                const url = schema ? `${API_BASE}/db/tables?schema=${encodeURIComponent(schema)}` : `${API_BASE}/db/tables`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.tables) {
                    tablesContainer.innerHTML = '';
                    data.tables.forEach(table => {
                        const label = document.createElement('label');
                        label.className = 'table-item';
                        label.innerHTML = `
                            <input type="checkbox" value="${table}" checked>
                            <span>${table}</span>
                        `;
                        tablesContainer.appendChild(label);
                    });
                }
            } catch (error) {
                tablesContainer.innerHTML = `<p class="hint error">Error loading tables: ${error.message}</p>`;
            }
        }

        schemaSelect.addEventListener('change', (e) => loadTables(e.target.value));

        async function startDbIngestionStream() {
            const selectedTables = Array.from(tablesContainer.querySelectorAll('input:checked'))
                .map(cb => cb.value);

            if (selectedTables.length === 0) {
                alert('Please select at least one table.');
                return;
            }

            const schema = schemaSelect.value;
            let streamUrl = `${API_BASE}/ingest/db/stream?tables=${selectedTables.join(',')}`;
            if (schema) streamUrl += `&schema=${encodeURIComponent(schema)}`;

            dbIngestBtn.disabled = true;
            logToConsole(`Starting DATABASE INGESTION for ${selectedTables.length} tables...`, 'system');

            try {
                const response = await fetch(streamUrl);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.trim()) {
                            let type = 'info';
                            if (line.includes('ERROR') || line.includes('SKIP')) type = 'error';
                            if (line.includes('SUCCESS') || line.includes('Added')) type = 'success';
                            if (line.includes('WARNING')) type = 'warning';
                            logToConsole(line, type);
                        }
                    });
                }
                logToConsole('Database ingestion finished.', 'system');
            } catch (error) {
                logToConsole(`DB STREAM ERROR: ${error.message}`, 'error');
            } finally {
                dbIngestBtn.disabled = false;
            }
        }

        dbIngestBtn.addEventListener('click', startDbIngestionStream);

        // Mobile Sidebar Toggle Logic
        const menuToggle = document.getElementById('menu-toggle');
        const closeSidebar = document.getElementById('close-sidebar');
        const sidebar = document.querySelector('.sidebar');

        menuToggle.onclick = () => {
            sidebar.classList.add('mobile-active');
        };

        closeSidebar.onclick = () => {
            sidebar.classList.remove('mobile-active');
        };

        // Close sidebar when clicking a nav item on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                sidebar.classList.remove('mobile-active');
            });
        });

        // Update window click handler to close both modals AND sidebar
        window.onclick = (event) => {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
            if (event.target == dbModal) {
                dbModal.style.display = 'none';
            }
            if (event.target == sidebar && sidebar.classList.contains('mobile-active')) {
                sidebar.classList.remove('mobile-active');
            }
        }
    </script>
</body>

</html>