<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASU Engineering RAG AI</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        asu: {
                            blue: '#1e3a8a',
                            gold: '#ca8a04',
                            light: '#f3f4f6',
                            dark: '#111827'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #374151;
        }

        /* Markdown Styles */
        .markdown-body p {
            margin-bottom: 0.75em;
        }

        .markdown-body pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        .markdown-body code {
            background: #e2e8f0;
            color: #d946ef;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }

        .dark .markdown-body code {
            background: #374151;
            color: #f0abfc;
        }

        .markdown-body ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }

        /* Enhanced Citations */
        .citation-group {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin: 0 2px;
            vertical-align: middle;
        }

        .citation-link {
            cursor: pointer;
            color: #1e3a8a;
            background: #dbeafe;
            padding: 1px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            border: 1px solid #bfdbfe;
            transition: all 0.2s;
        }

        .dark .citation-link {
            color: #93c5fd;
            background: #1e3a8a;
            border-color: #1e40af;
        }

        .citation-link:hover {
            background: #bfdbfe;
            border-color: #3b82f6;
        }

        .citation-direct-btn {
            padding: 2px 6px;
            border-radius: 4px;
            background: #f3f4f6;
            color: #6b7280;
            font-size: 0.7rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .dark .citation-direct-btn {
            background: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }

        .citation-direct-btn:hover {
            background: #e5e7eb;
            color: #1e3a8a;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .dark .modal-content {
            background: #1f2937;
            border: 1px solid #374151;
        }

        .chunk-card {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            background: #f9fafb;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dark .chunk-card {
            background: #111827;
            border-color: #374151;
        }

        .chunk-used {
            border: 2px solid #1e3a8a;
            background: #eff6ffef;
        }

        .dark .chunk-used {
            border-color: #3b82f6;
            background: rgba(30, 58, 138, 0.2);
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen overflow-hidden transition-colors duration-200">

    <div id="app" class="flex h-full">

        <aside
            :class="['fixed z-20 inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform transition-transform duration-300 md:relative md:translate-x-0', sidebarOpen ? 'translate-x-0' : '-translate-x-full']">
            <div class="flex flex-col h-full">
                <div class="p-4 flex items-center gap-3 border-b border-gray-200 dark:border-gray-700">
                    <img src="/client/logo.png" alt="ASU Logo" class="h-10 w-10 object-contain">
                    <div>
                        <h1 class="font-bold text-sm tracking-wide text-asu-blue dark:text-white">ASU ENG AI</h1>
                        <span class="text-xs text-gray-500 dark:text-gray-400">RAG Knowledge System</span>
                    </div>
                </div>

                <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div @click="currentView = 'view-chat'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-chat' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-comment-dots"></i>
                        <span class="font-medium">Chat Assistant</span>
                    </div>
                    <div @click="currentView = 'view-pdf'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-pdf' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-file-alt"></i>
                        <span class="font-medium">Documents</span>
                    </div>
                    <div @click="currentView = 'view-web'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-web' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-globe"></i>
                        <span class="font-medium">Web Content</span>
                    </div>
                    <div @click="currentView = 'view-db'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-db' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-database"></i>
                        <span class="font-medium">SQL Databases</span>
                    </div>
                    <div @click="currentView = 'view-manage'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-manage' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-tasks"></i>
                        <span class="font-medium">Management</span>
                    </div>
                    <div @click="currentView = 'view-settings'"
                        :class="['flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all', currentView === 'view-settings' ? 'bg-asu-blue text-white shadow-md shadow-blue-200 dark:shadow-none' : 'hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300']">
                        <i class="fa-solid fa-cog"></i>
                        <span class="font-medium">Settings</span>
                    </div>
                </nav>

                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Appearance</span>
                        <button @click="toggleTheme"
                            class="w-8 h-8 flex items-center justify-center rounded-full bg-white dark:bg-gray-800 shadow-sm text-gray-500 hover:text-asu-blue transition-colors">
                            <i v-if="isDark" class="fa-solid fa-sun text-yellow-500"></i>
                            <i v-else class="fa-solid fa-moon text-blue-500"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative">

            <div
                class="md:hidden p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800">
                <button @click="sidebarOpen = !sidebarOpen" class="text-gray-600 dark:text-gray-300">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <span class="font-bold">ASU Chat</span>
                <div class="w-6"></div>
            </div>

            <!-- View: Chat Assistant -->
            <div v-if="currentView === 'view-chat'" class="flex-1 flex flex-col h-full overflow-hidden">
                <div ref="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                    <div v-if="messages.length === 0"
                        class="h-full flex flex-col items-center justify-center text-center opacity-60">
                        <img src="/client/logo.png" class="h-24 w-24 mb-6 opacity-80 grayscale">
                        <h2 class="text-2xl font-bold mb-2">How can I help you today?</h2>
                        <p class="max-w-md text-sm">Ask about engineering concepts, analyze files, or search across your
                            knowledge base.</p>
                    </div>

                    <div v-for="(msg, index) in messages" :key="index" class="flex gap-4 max-w-4xl mx-auto"
                        :class="msg.role === 'user' ? 'flex-row-reverse' : ''">
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm"
                            :class="msg.role === 'user' ? 'bg-gray-500' : 'bg-asu-blue'">
                            <i v-if="msg.role === 'user'" class="fa-solid fa-user"></i>
                            <img v-else src="/client/logo.png"
                                class="w-full h-full object-cover rounded-full bg-white p-0.5">
                        </div>

                        <div class="group relative max-w-[85%]">
                            <div class="p-4 rounded-2xl shadow-sm text-sm leading-relaxed"
                                :class="msg.role === 'user' ? 'bg-asu-blue text-white rounded-tr-none' : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-tl-none'">
                                <div v-if="msg.attachments && msg.attachments.length > 0"
                                    class="mb-3 flex flex-wrap gap-2">
                                    <div v-for="att in msg.attachments"
                                        class="bg-black/10 px-2 py-1 rounded text-xs flex items-center gap-1">
                                        <i class="fa-solid fa-paperclip"></i> {{ att }}
                                    </div>
                                </div>
                                <div v-if="msg.role === 'assistant'" v-html="renderMarkdown(msg.content)"
                                    class="markdown-body"></div>
                                <div v-else class="whitespace-pre-wrap">{{ msg.content }}</div>
                            </div>
                            <div v-if="msg.metadata" class="mt-2 flex flex-wrap gap-2 opacity-80">
                                <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px]"><i
                                        class="fas fa-microchip mr-1"></i>{{ msg.metadata.model }}</span>
                                <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px]"><i
                                        class="fas fa-clock mr-1"></i>{{ msg.metadata.performance.total }}</span>
                                <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px]"><i
                                        class="fas fa-brain mr-1"></i>{{ msg.metadata.tokens }} tokens</span>
                                <button v-if="index === messages.length - 1 && msg.role === 'assistant'"
                                    @click="sendMessage(true)" class="text-[10px] text-asu-blue hover:underline"><i
                                        class="fas fa-play mr-1"></i>Continue</button>
                            </div>
                            <div class="absolute -bottom-6 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"
                                :class="msg.role === 'user' ? 'right-0' : 'left-0'">
                                <button @click="copyText(msg.content)"
                                    class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i
                                        class="fa-regular fa-copy"></i> Copy</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="isStreaming" class="flex gap-4 max-w-4xl mx-auto">
                        <div class="w-8 h-8 rounded-full bg-asu-blue flex-shrink-0 flex items-center justify-center">
                            <img src="/client/logo.png" class="w-full h-full object-cover rounded-full bg-white p-0.5">
                        </div>
                        <div
                            class="bg-white dark:bg-gray-800 p-4 rounded-2xl rounded-tl-none border border-gray-100 dark:border-gray-700">
                            <div class="flex gap-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-75"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                    <div class="max-w-4xl mx-auto relative">
                        <div v-if="pendingFiles.length > 0" class="flex gap-2 mb-2 overflow-x-auto pb-2">
                            <div v-for="(file, idx) in pendingFiles" :key="idx"
                                class="relative bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-md text-xs flex items-center gap-2">
                                <span class="truncate max-w-[100px]">{{ file.name }}</span>
                                <button @click="removeFile(idx)" class="text-red-500 hover:text-red-700"><i
                                        class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                        <div
                            class="flex items-end gap-2 bg-gray-100 dark:bg-gray-900 p-2 rounded-xl border border-transparent focus-within:border-asu-blue transition-colors">
                            <select v-model="chatMode"
                                class="bg-transparent text-xs font-bold text-asu-blue dark:text-gray-300 border-none focus:ring-0 cursor-pointer">
                                <option value="normal">ðŸ”˜ Normal</option>
                                <option value="deep">ðŸ§  Deep</option>
                            </select>
                            <input type="file" ref="fileInput" multiple hidden @change="handleFileUpload">
                            <textarea v-model="inputMessage" @keydown.enter.prevent="sendMessage(false)"
                                placeholder="Message ASU RAG Assistant..." rows="1"
                                class="flex-1 bg-transparent border-none focus:ring-0 resize-none max-h-32 py-2 text-sm md:text-base custom-scrollbar"></textarea>
                            <button @click="toggleRecording"
                                :class="isRecording ? 'text-red-500 animate-pulse' : 'text-gray-500'"
                                class="p-2 hover:text-asu-blue transition-colors rounded-lg"><i
                                    class="fa-solid fa-microphone text-lg"></i></button>
                            <button @click="sendMessage(false)" :disabled="!inputMessage && pendingFiles.length === 0"
                                class="w-10 h-10 flex items-center justify-center bg-asu-blue text-white rounded-lg shadow-sm hover:bg-blue-900 disabled:opacity-30 disabled:cursor-not-allowed transition-all"><i
                                    class="fa-solid fa-arrow-up text-lg"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Documents -->
            <div v-if="currentView === 'view-pdf'" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i
                                class="fas fa-file-alt text-asu-blue"></i> Document Management</h3>
                        <div @click="$refs.fileInput.click()"
                            class="border-2 border-dashed border-gray-200 dark:border-gray-600 rounded-xl p-8 text-center cursor-pointer hover:border-asu-blue transition-colors group">
                            <i
                                class="fas fa-cloud-upload-alt text-4xl text-gray-300 group-hover:text-asu-blue mb-4 transition-colors"></i>
                            <p class="text-gray-500 dark:text-gray-400">Click or drag & drop files here</p>
                        </div>
                        <div v-if="pendingFiles.length > 0" class="mt-4 flex flex-wrap gap-2">
                            <div v-for="(file, idx) in pendingFiles" @click="removeFile(idx)"
                                class="bg-asu-blue/10 text-asu-blue px-3 py-1 rounded-full text-xs flex items-center gap-2 cursor-pointer hover:bg-red-100 hover:text-red-500 transition-colors">
                                <i class="fas fa-file-pdf"></i> {{ file.name }} <i class="fas fa-times"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-6">
                            <button @click="uploadFiles" :disabled="pendingFiles.length === 0"
                                class="bg-asu-blue text-white py-2 rounded-lg font-medium disabled:opacity-50">Upload
                                Selected</button>
                            <button @click="startIngestion('quick')"
                                class="bg-yellow-600 text-white py-2 rounded-lg font-medium">Quick Sync</button>
                            <button @click="startIngestion('fresh')"
                                class="bg-red-600 text-white py-2 rounded-lg font-medium">Fresh Build</button>
                        </div>
                    </div>
                    <div
                        class="bg-black/90 text-green-500 rounded-xl p-4 font-mono text-xs h-64 overflow-y-auto shadow-inner">
                        <div v-for="log in ingestionLogs.pdf" class="py-0.5">> {{ log }}</div>
                        <div v-if="ingestionLogs.pdf.length === 0">> Document synchronization updates appear here.</div>
                    </div>
                </div>
            </div>

            <!-- View: Web Content -->
            <div v-if="currentView === 'view-web'" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i
                                class="fas fa-globe text-asu-blue"></i> Web Ingestion</h3>
                        <div class="flex gap-2">
                            <input v-model="webUrl" type="text" placeholder="https://example.com/about"
                                class="flex-1 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-lg p-3 text-sm">
                            <button @click="startWebIngest"
                                class="bg-asu-blue text-white px-6 rounded-lg font-medium hover:bg-blue-900 transition-colors">Crawl
                                & Ingest</button>
                        </div>
                    </div>
                    <div
                        class="bg-black/90 text-green-500 rounded-xl p-4 font-mono text-xs h-64 overflow-y-auto shadow-inner">
                        <div v-for="log in ingestionLogs.web" class="py-0.5">> {{ log }}</div>
                    </div>
                </div>
            </div>

            <!-- View: SQL DB -->
            <div v-if="currentView === 'view-db'" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i
                                class="fas fa-database text-asu-blue"></i> Database Ingestion</h3>
                        <div class="space-y-4">
                            <select v-model="selectedSchema" @change="fetchTables"
                                class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-lg p-3 text-sm">
                                <option value="">Choose a schema...</option>
                                <option v-for="s in dbSchemas" :value="s">{{ s }}</option>
                            </select>
                            <div v-if="dbTables.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <div v-for="t in dbTables"
                                    class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-100 dark:border-gray-700">
                                    <input type="checkbox" :value="t" v-model="selectedTables"
                                        class="rounded text-asu-blue">
                                    <span class="text-xs truncate">{{ t }}</span>
                                </div>
                            </div>
                            <button @click="startDbIngest" :disabled="!selectedSchema || selectedTables.length === 0"
                                class="w-full bg-asu-blue text-white py-3 rounded-xl font-bold hover:bg-blue-900 transition-all disabled:opacity-30">Ingest
                                Selected Tables</button>
                        </div>
                    </div>
                    <div
                        class="bg-black/90 text-green-500 rounded-xl p-4 font-mono text-xs h-64 overflow-y-auto shadow-inner">
                        <div v-for="log in ingestionLogs.db" class="py-0.5">> {{ log }}</div>
                    </div>
                </div>
            </div>

            <!-- View: Management -->
            <div v-if="currentView === 'view-manage'" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <span class="text-xs text-gray-400 uppercase font-bold">Total Documents</span>
                            <div class="text-2xl font-bold text-asu-blue">{{ indexStats.total_documents }}</div>
                        </div>
                        <div
                            class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <span class="text-xs text-gray-400 uppercase font-bold">Total Chunks</span>
                            <div class="text-2xl font-bold text-asu-blue">{{ indexStats.total_chunks }}</div>
                        </div>
                        <button @click="syncIndex"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-bold text-sm transition-all"><i
                                class="fas fa-sync-alt mr-2"></i>Sync Missing</button>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="text-lg font-bold mb-4">Managed Resources</h3>
                        <div class="space-y-4">
                            <div v-for="(items, category) in resourceList" :key="category">
                                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">{{ category }}</h4>
                                <div class="space-y-1">
                                    <div v-for="item in items" @click="openPreview(item)"
                                        class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded-xl group cursor-pointer hover:border-asu-blue border border-transparent">
                                        <div class="flex items-center gap-3">
                                            <i class="fas"
                                                :class="category === 'documents' ? 'fa-file-pdf' : (category === 'websites' ? 'fa-globe' : 'fa-table')"></i>
                                            <span class="text-sm font-medium">{{ item }}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="text-[10px] bg-asu-blue/10 text-asu-blue px-2 py-0.5 rounded-full">{{
                                                indexStats.sources[item] || 0 }} chunks</span>
                                            <button @click.stop="deleteResource(category, item)"
                                                class="text-gray-400 hover:text-red-500 p-1"><i
                                                    class="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-red-100 dark:border-red-900/30">
                        <h3 class="text-lg font-bold mb-4 text-red-600">Danger Zone</h3>
                        <button @click="wipeAllData"
                            class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-all">Wipe
                            All Data & Reset System</button>
                    </div>
                </div>
            </div>

            <!-- View: Settings -->
            <div v-if="currentView === 'view-settings'" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div class="max-w-2xl mx-auto">
                    <div
                        class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="text-2xl font-bold mb-6">System Configuration</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold mb-2">LLM Provider</label>
                                <select v-model="settings.provider" @change="loadModels('llm')"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-xl p-3">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="ollama">Ollama (Local)</option>
                                    <option value="vllm">vLLM (Local)</option>
                                </select>
                            </div>
                            <div v-if="settings.provider === 'openai' || settings.provider === 'gemini'"
                                class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2">API Key</label>
                                    <input v-if="settings.provider === 'openai'" v-model="settings.openaiKey"
                                        type="password" placeholder="OpenAI Key..."
                                        class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-xl p-3">
                                    <input v-if="settings.provider === 'gemini'" v-model="settings.geminiKey"
                                        type="password" placeholder="Gemini Key..."
                                        class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-xl p-3">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">LLM Model</label>
                                <select v-model="settings.llmModel"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-xl p-3">
                                    <option v-for="m in modelLists.llm" :value="m">{{ m }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-2">Embedding Provider</label>
                                <select v-model="settings.embedProvider" @change="loadModels('embed')"
                                    class="w-full bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-xl p-3">
                                    <option value="openai">OpenAI</option>
                                    <option value="ollama">Ollama (Local)</option>
                                    <option value="vllm">vLLM (Local)</option>
                                </select>
                            </div>
                            <button @click="saveSettings"
                                class="w-full bg-asu-blue text-white py-4 rounded-xl font-bold shadow-lg transition-all text-lg">Save
                                Configuration</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Modal -->
            <div v-if="previewSourceState.visible" class="modal-overlay">
                <div class="modal-content flex flex-col">
                    <div
                        class="p-6 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800">
                        <div>
                            <h3 class="text-lg font-bold flex items-center gap-2"><i
                                    class="fas fa-database text-asu-blue"></i> {{ previewSourceState.name }}</h3>
                            <p class="text-xs text-gray-400">{{ previewSourceState.chunks.length }} chunks found in
                                index</p>
                        </div>
                        <button @click="previewSourceState.visible = false"
                            class="text-gray-400 hover:text-red-500 transition-colors"><i
                                class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div v-for="(chunk, idx) in previewSourceState.chunks" :key="idx"
                            :class="['chunk-card p-4 rounded-xl border transition-all', chunk.used ? 'chunk-used border-asu-blue bg-blue-50 dark:bg-blue-900/10' : 'bg-white dark:bg-gray-900 border-gray-100 dark:border-gray-800']">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">CHUNK #{{ idx + 1 }}</span>
                                <span v-if="chunk.page"
                                    class="text-[10px] bg-asu-blue/10 text-asu-blue px-2 py-0.5 rounded-full">PAGE {{
                                    chunk.page }}</span>
                                <span v-if="chunk.used"
                                    class="text-[10px] bg-asu-blue text-white px-2 py-0.5 rounded-full">USED IN
                                    ANSWER</span>
                            </div>
                            <div class="text-sm dark:text-gray-300">{{ chunk.content }}</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick, watch } = Vue;
        const API_BASE = window.location.origin;

        createApp({
            setup() {
                const currentView = ref('view-chat');
                const messages = ref([]);
                const inputMessage = ref("");
                const sidebarOpen = ref(false);
                const isDark = ref(false);
                const isStreaming = ref(false);
                const messagesContainer = ref(null);
                const fileInput = ref(null);
                const pendingFiles = ref([]);
                const chatMode = ref('normal');
                const isRecording = ref(false);

                const settings = ref({ provider: 'openai', embedProvider: 'openai', openaiKey: '', geminiKey: '', llmModel: '', embedModel: '' });
                const modelLists = ref({ llm: [], embed: [] });
                const resourceList = ref({ documents: [], websites: [], databases: [] });
                const indexStats = ref({ total_documents: 0, total_chunks: 0, sources: {} });
                const ingestionLogs = ref({ pdf: [], web: [], db: [] });

                const webUrl = ref("");
                const dbSchemas = ref([]);
                const dbTables = ref([]);
                const selectedSchema = ref("");
                const selectedTables = ref([]);
                const sourceMap = ref({});
                const currentUsedDocs = ref([]);
                const previewSourceState = ref({ visible: false, name: '', chunks: [] });

                let recognition = null;
                if (window.SpeechRecognition || window.webkitSpeechRecognition) {
                    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new Speech();
                    recognition.onstart = () => { isRecording.value = true; };
                    recognition.onend = () => { isRecording.value = false; };
                    recognition.onresult = (e) => {
                        const transcript = e.results[0][0].transcript;
                        inputMessage.value = inputMessage.value ? `${inputMessage.value} ${transcript}` : transcript;
                    };
                }

                onMounted(async () => {
                    await loadCurrentConfig();
                    await fetchResources();
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) isDark.value = true;
                    applyTheme();
                });

                watch(isDark, applyTheme);
                watch(currentView, (newView) => {
                    if (newView === 'view-manage') fetchResources();
                    if (newView === 'view-db' && dbSchemas.value.length === 0) fetchSchemas();
                });

                function applyTheme() {
                    if (isDark.value) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                }
                function toggleTheme() { isDark.value = !isDark.value; }

                function renderMarkdown(text) {
                    const renderer = new marked.Renderer();
                    renderer.text = function (token) {
                        const content = typeof token === 'string' ? token : token.text;
                        if (!content) return '';
                        return content.replace(/\[([^\]]+)\]/g, (match, inner) => {
                            let clean = inner.replace(/SOURCE:/gi, '').replace(/PAGE:/gi, '').replace(/\|/g, ',').trim();
                            const parts = clean.split(',').map(s => s.trim());
                            let possibleFile = parts[0].replace(/^\(|\)$/g, '').trim();
                            const sourcePath = sourceMap.value[possibleFile] || Object.values(sourceMap.value).find(s => s.includes(possibleFile));
                            if (sourcePath) {
                                const isUrl = sourcePath.startsWith('http');
                                const safeName = possibleFile.replace(/'/g, "\\'");
                                const icon = isUrl ? 'fa-globe' : (possibleFile.includes('Table:') ? 'fa-table' : 'fa-file-alt');
                                const openUrl = isUrl ? sourcePath : `${API_BASE}/files/${possibleFile}`;
                                return `
                                    <span class="citation-group">
                                        <span class="citation-link" onclick="window.previewSourceInModal('${safeName}')" title="View Index: ${possibleFile}">
                                            <i class="fas ${icon}"></i> ${possibleFile}
                                        </span>
                                        <button class="citation-direct-btn" onclick="window.open('${openUrl}', '_blank')" title="Open Original">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                    </span>`;
                            }
                            return match;
                        });
                    };
                    return marked.parse(text, { renderer });
                }

                const scrollToBottom = () => nextTick(() => { if (messagesContainer.value) messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight; });

                async function loadCurrentConfig() {
                    try {
                        const res = await fetch(`${API_BASE}/config/current`);
                        const data = await res.json();
                        settings.value.provider = data.provider;
                        settings.value.embedProvider = data.embedding_provider;
                        settings.value.openaiKey = data.openai?.api_key || '';
                        settings.value.geminiKey = data.gemini?.api_key || '';

                        // Extract current model based on provider
                        if (data.provider === 'openai') settings.value.llmModel = data.openai.model;
                        else if (data.provider === 'gemini') settings.value.llmModel = data.gemini.model;
                        else if (data.provider === 'ollama') settings.value.llmModel = data.ollama.model;
                        else if (data.provider === 'vllm') settings.value.llmModel = data.vllm.model;

                        if (settings.value.provider) await loadModels('llm');
                        if (settings.value.embedProvider) await loadModels('embed');
                    } catch (e) { console.error("Config load failed", e); }
                }

                async function loadModels(type) {
                    const provider = type === 'llm' ? settings.value.provider : settings.value.embedProvider;
                    try {
                        const res = await fetch(`${API_BASE}/models/${provider}`);
                        const data = await res.json();
                        modelLists.value[type] = data.models || [];
                    } catch (e) { console.error("Models load failed", e); }
                }

                async function saveSettings() {
                    const updates = {
                        "LLM_PROVIDER": settings.value.provider,
                        "EMBEDDING_PROVIDER": settings.value.embedProvider,
                        "OPENAI_API_KEY": settings.value.openaiKey,
                        "GEMINI_API_KEY": settings.value.geminiKey
                    };
                    if (settings.value.provider === 'openai') updates["OPENAI_LLM_MODEL"] = settings.value.llmModel;
                    if (settings.value.provider === 'gemini') updates["GEMINI_MODEL"] = settings.value.llmModel;

                    await fetch(`${API_BASE}/config/update`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });
                    alert("Settings updated!");
                }

                async function fetchResources() {
                    const res = await fetch(`${API_BASE}/resources`);
                    resourceList.value = await res.json();
                    const stats = await fetch(`${API_BASE}/index/stats`);
                    indexStats.value = await stats.json();
                }

                async function sendMessage(isContinuation = false) {
                    if ((!inputMessage.value.trim() && !isContinuation && pendingFiles.value.length === 0) || isStreaming.value) return;
                    const text = isContinuation ? "" : inputMessage.value;
                    const files = [...pendingFiles.value];
                    inputMessage.value = ""; pendingFiles.value = [];

                    if (!isContinuation) {
                        messages.value.push({ role: 'user', content: text, attachments: files.map(f => f.name) });
                    }
                    scrollToBottom();

                    const uploaded = [];
                    for (const f of files) {
                        const fd = new FormData(); fd.append('file', f);
                        const r = await fetch(`${API_BASE}/upload`, { method: 'POST', body: fd });
                        const d = await r.json(); uploaded.push(d.url);
                    }

                    isStreaming.value = true;
                    const botMsg = { role: 'assistant', content: "", metadata: null };
                    messages.value.push(botMsg);

                    try {
                        const url = isContinuation
                            ? `${API_BASE}/ask/stream?question=${encodeURIComponent(messages.value[messages.value.length - 2].content)}&is_continuation=true&last_answer=${encodeURIComponent(messages.value[messages.value.length - 2].content)}`
                            : `${API_BASE}/ask/stream?question=${encodeURIComponent(text)}&deep_thinking=${chatMode.value === 'deep'}`;

                        const response = await fetch(url);
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const lines = decoder.decode(value).split('\n');
                            for (const line of lines) {
                                if (!line.trim()) continue;
                                const data = JSON.parse(line);
                                if (data.type === 'sources') {
                                    data.sources.forEach(src => {
                                        const name = src.startsWith('http') ? src : src.split('/').pop();
                                        sourceMap.value[name] = src;
                                    });
                                }
                                if (data.type === 'chunk') botMsg.content += data.content;
                                if (data.type === 'metadata') {
                                    botMsg.metadata = data;
                                    currentUsedDocs.value = data.used_docs || [];
                                }
                                scrollToBottom();
                            }
                        }
                    } catch (e) { botMsg.content = "Error: " + e.message; }
                    finally { isStreaming.value = false; }
                }

                function handleFileUpload(e) {
                    const files = Array.from(e.target.files);
                    files.forEach(f => pendingFiles.value.push(f));
                    e.target.value = null;
                }

                function removeFile(index) {
                    pendingFiles.value.splice(index, 1);
                }

                function toggleRecording() {
                    if (!recognition) { alert("Not supported"); return; }
                    if (isRecording.value) recognition.stop(); else recognition.start();
                }

                async function uploadFiles() {
                    for (const file of pendingFiles.value) {
                        const fd = new FormData(); fd.append('file', file);
                        await fetch(`${API_BASE}/upload`, { method: 'POST', body: fd });
                    }
                    pendingFiles.value = []; alert("Uploaded!"); fetchResources();
                }

                async function startIngestion(mode) {
                    const url = `${API_BASE}/ingest/document/stream${mode === 'fresh' ? '?fresh=true' : ''}`;
                    ingestionLogs.value.pdf = [];
                    const res = await fetch(url);
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const lines = decoder.decode(value).split('\n');
                        lines.forEach(l => { if (l.trim()) ingestionLogs.value.pdf.push(l); });
                    }
                    fetchResources();
                }

                async function startWebIngest() {
                    const url = `${API_BASE}/ingest/web/stream?url=${encodeURIComponent(webUrl.value)}`;
                    ingestionLogs.value.web = [];
                    const res = await fetch(url);
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const lines = decoder.decode(value).split('\n');
                        lines.forEach(l => { if (l.trim()) ingestionLogs.value.web.push(l); });
                    }
                    fetchResources();
                }

                async function fetchSchemas() {
                    const res = await fetch(`${API_BASE}/ingest/db/schemas`);
                    dbSchemas.value = await res.json();
                }

                async function fetchTables() {
                    const res = await fetch(`${API_BASE}/ingest/db/tables?schema=${selectedSchema.value}`);
                    dbTables.value = await res.json();
                }

                async function startDbIngest() {
                    const url = `${API_BASE}/ingest/db/stream`;
                    ingestionLogs.value.db = [];
                    const res = await fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: selectedSchema.value, tables: selectedTables.value })
                    });
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const lines = decoder.decode(value).split('\n');
                        lines.forEach(l => { if (l.trim()) ingestionLogs.value.db.push(l); });
                    }
                    fetchResources();
                }

                async function openPreview(name) {
                    previewSourceState.value.name = name;
                    previewSourceState.value.visible = true;
                    try {
                        const res = await fetch(`${API_BASE}/index/preview?source=${encodeURIComponent(name)}`);
                        const chunks = await res.json();
                        const usedContents = new Set(currentUsedDocs.value.filter(d => d.source === name).map(d => d.content.trim()));
                        previewSourceState.value.chunks = chunks.map(c => ({ ...c, used: usedContents.has(c.content.trim()) }));
                    } catch (e) { console.error(e); }
                }
                window.previewSourceInModal = openPreview;

                async function deleteResource(type, name) {
                    if (confirm(`Delete ${name}?`)) {
                        await fetch(`${API_BASE}/resources/${type}/${encodeURIComponent(name)}`, { method: 'DELETE' });
                        fetchResources();
                    }
                }

                async function wipeAllData() {
                    if (confirm("Reset everything?")) {
                        await fetch(`${API_BASE}/resources/reset`, { method: 'POST' });
                        location.reload();
                    }
                }

                return {
                    currentView, messages, inputMessage, sidebarOpen, isDark, isStreaming, messagesContainer, fileInput, pendingFiles, chatMode, isRecording,
                    settings, modelLists, resourceList, indexStats, ingestionLogs, webUrl, dbSchemas, dbTables, selectedSchema, selectedTables,
                    previewSourceState,
                    toggleTheme, renderMarkdown, handleFileUpload, removeFile, uploadFiles, startIngestion, startWebIngest, fetchTables, startDbIngest, sendMessage, toggleRecording, deleteResource, wipeAllData, openPreview, syncIndex: () => startIngestion('quick'), copyText: (t) => { navigator.clipboard.writeText(t); alert("Copied!"); }
                };
            }
        }).mount('#app');
    </script>
</body>

</html>