<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASU Engineering RAG Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Plus+Jakarta+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <div class="icon">ðŸ¤–</div>
                <h1>ASU Engineering <span>Assistant</span></h1>
            </div>
            <div class="header-actions">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connected</span>
                </div>
                <button id="settings-btn" title="Model Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Model Settings</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <label for="model-select">Current Ollama Model:</label>
                    <select id="model-select">
                        <option value="">Loading models...</option>
                    </select>
                    <p class="helper-text">Select a model from your local Ollama instance.</p>
                </div>
                <div class="modal-footer">
                    <button id="save-settings" class="primary-btn">Save Changes</button>
                </div>
            </div>
        </div>

        <main id="chat-container">
            <div class="welcome-message">
                <div class="bot-avatar">AI</div>
                <h2>How can I help you today?</h2>
                <p>I can help you with information about ASU Engineering bylaws, departments, and programs.</p>
                <div class="suggested-queries">
                    <button onclick="setQuery('What are the available departments?')">Available departments</button>
                    <button onclick="setQuery('Tell me about the bylaws.')">Bylaws info</button>
                    <button onclick="setQuery('What are the program requirements?')">Program requirements</button>
                </div>
            </div>
        </main>

        <footer>
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Type your question here..." autocomplete="off">
                <button id="send-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            <p class="disclaimer">Retrieved from official ASU Engineering documents and website.</p>
        </footer>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        // Dynamically get the API base URL from the current window location
        const API_BASE = window.location.origin;

        function setQuery(query) {
            userInput.value = query;
            sendMessage();
        }

        function addMessage(content, isUser = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerText = isUser ? 'ðŸ‘¤' : 'AI';

            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            textDiv.innerText = content;

            msgDiv.appendChild(avatar);
            msgDiv.appendChild(textDiv);
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return textDiv;
        }

        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question) return;

            userInput.value = '';
            addMessage(question, true);

            const botTextDiv = addMessage('', false);
            botTextDiv.innerHTML = '<div class="typing">AI Assistant is thinking...</div>';

            try {
                const response = await fetch(`${API_BASE}/ask/stream?question=${encodeURIComponent(question)}`);

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedAnswer = '';

                botTextDiv.innerHTML = ''; // Clear thinking state

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const data = JSON.parse(line);
                            if (data.type === 'sources') {
                                // Optional: display sources separately
                                console.log('Sources:', data.sources);
                            } else if (data.type === 'chunk') {
                                accumulatedAnswer += data.content;
                                botTextDiv.innerText = accumulatedAnswer;
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } else if (data.type === 'metadata') {
                                // Add performance metrics and sources
                                const metaDiv = document.createElement('div');
                                metaDiv.className = 'message-meta';

                                const stats = [
                                    { label: 'Model', value: data.model, icon: 'fa-robot' },
                                    { label: 'Total', value: data.performance.total, icon: 'fa-clock' },
                                    { label: 'LLM', value: data.performance.llm, icon: 'fa-microchip' },
                                    { label: 'Tokens', value: data.tokens, icon: 'fa-brain' }
                                ];

                                stats.forEach(stat => {
                                    const item = document.createElement('div');
                                    item.className = 'meta-item';
                                    item.innerHTML = `<i class="fas ${stat.icon}"></i> ${stat.label}: ${stat.value}`;
                                    metaDiv.appendChild(item);
                                });

                                if (data.sources && data.sources.length > 0) {
                                    const sourceContainer = document.createElement('div');
                                    sourceContainer.className = 'source-badges';
                                    data.sources.forEach(src => {
                                        const badge = document.createElement('span');
                                        badge.className = 'source-badge';
                                        badge.innerText = src.startsWith('http') ? new URL(src).hostname : src.split('/').pop();
                                        badge.title = src;
                                        sourceContainer.appendChild(badge);
                                    });
                                    metaDiv.appendChild(sourceContainer);
                                }

                                botTextDiv.appendChild(metaDiv);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } else if (data.type === 'error') {
                                botTextDiv.innerText = `Error: ${data.content}`;
                            }
                        } catch (e) {
                            console.error('Error parsing JSON chunk', e);
                        }
                    }
                }
            } catch (error) {
                botTextDiv.innerText = `Error: ${error.message}`;
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Settings Modal Logic
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeModal = document.querySelector('.close-modal');
        const modelSelect = document.getElementById('model-select');
        const saveSettings = document.getElementById('save-settings');

        settingsBtn.onclick = async () => {
            settingsModal.style.display = 'block';
            await loadModels();
        }

        closeModal.onclick = () => {
            settingsModal.style.display = 'none';
        }

        window.onclick = (event) => {
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
        }

        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/models/ollama`);
                const data = await response.json();

                modelSelect.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.text = model;
                    if (model === data.current) option.selected = true;
                    modelSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load models:', error);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        saveSettings.onclick = async () => {
            const selectedModel = modelSelect.value;
            if (!selectedModel) return;

            saveSettings.innerText = 'Saving...';
            saveSettings.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/config/update_model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedModel })
                });

                if (response.ok) {
                    settingsModal.style.display = 'none';
                    alert(`Model switched to ${selectedModel}`);
                }
            } catch (error) {
                alert('Failed to update model settings');
            } finally {
                saveSettings.innerText = 'Save Changes';
                saveSettings.disabled = false;
            }
        }
    </script>
</body>

</html>